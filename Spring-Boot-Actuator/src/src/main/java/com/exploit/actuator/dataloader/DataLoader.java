package com.exploit.actuator.dataloader;

import com.exploit.actuator.dto.UserRegistrationDto;
import com.exploit.actuator.model.User;
import com.exploit.actuator.repository.UserRepository;
import com.exploit.actuator.service.UserService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.ApplicationArguments;
import org.springframework.boot.ApplicationRunner;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Lazy;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Component;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;

import java.net.URI;
import java.net.URISyntaxException;
import java.util.HashMap;
import java.util.Map;

@Service
@Component
public class DataLoader implements ApplicationRunner {

    @Autowired
    UserService userService;
    @Autowired
    UserRepository userRepository;
    @Autowired
    @Lazy
    AuthenticationManager authManager;

    private Logger logger = LoggerFactory.getLogger(ApplicationRunner.class);


    public void run(ApplicationArguments args) throws URISyntaxException {
        User user = userRepository.findByEmail("actuator@admin.com");
        if(user == null) {
            UserRegistrationDto userRegistrationDto = new UserRegistrationDto();
            userRegistrationDto.setConfirmEmail("actuator@admin.com");
            userRegistrationDto.setEmail("actuator@admin.com");
            userRegistrationDto.setRole("ROLE_ADMIN");
            userRegistrationDto.setPassword("$(*&SGF&Bjsfb(");
            userRegistrationDto.setConfirmPassword("$(*&SGF&Bjsfb(");
            userRegistrationDto.setFirstName("admin");
            userRegistrationDto.setLastName("tommy");

            userService.save(userRegistrationDto);
        }

        RestTemplate restTemplate = new RestTemplate();
        final String baseUrl = "http://localhost:8080/login";
        URI uri = new URI(baseUrl);
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);

        String params = "username=actuator%40admin.com&password=$(*%26SGF%26Bjsfb(";

        HttpEntity<String> entity = new HttpEntity<>(params, headers);



        ResponseEntity<String> response = restTemplate.postForEntity( uri, entity, String.class );

        System.out.println(response.getHeaders());

    }

}
